# Titan Worker - Celery Worker Container
#
# Builds a container for running Celery workers for batch processing.
#
# Build:
#   docker build -f deploy/Dockerfile.worker -t titan/worker .
#
# Run:
#   docker run -e CELERY_BROKER_URL=redis://redis:6379/1 titan/worker

FROM python:3.11-slim

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libffi-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy pyproject.toml for dependency info
COPY pyproject.toml ./

# Install Python dependencies
RUN pip install --no-cache-dir -U pip setuptools wheel && \
    pip install --no-cache-dir \
    celery[redis]>=5.3.0 \
    redis>=5.0.0 \
    boto3>=1.34.0 \
    psutil>=5.9.0 \
    pydantic>=2.0.0 \
    httpx>=0.25.0 \
    anthropic>=0.40.0 \
    openai>=1.50.0 \
    pyyaml>=6.0

# Copy application code
COPY titan/ ./titan/
COPY runtime/ ./runtime/
COPY hive/ ./hive/
COPY agents/ ./agents/

# Set Python path
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# Default environment variables
ENV CELERY_BROKER_URL=redis://localhost:6379/1
ENV CELERY_RESULT_BACKEND=redis://localhost:6379/2
ENV WORKER_RUNTIME_TYPE=docker
ENV CELERY_WORKER_CONCURRENCY=3
ENV TITAN_LOG_LEVEL=INFO

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD celery -A titan.batch.celery_app inspect ping || exit 1

# Default command: run Celery worker
CMD ["celery", "-A", "titan.batch.celery_app", "worker", "--loglevel=INFO"]
